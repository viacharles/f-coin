(window.webpackJsonp=window.webpackJsonp||[]).push([[7],{D7sm:function(e,t,n){"use strict";n.r(t),n.d(t,"ChatModule",function(){return X});var s=n("ofXK"),i=n("tyNb"),o=n("IzEk"),c=n("pLZG"),a=n("zx2A");class r{constructor(e){this.notifier=e}call(e,t){const n=new g(e),s=Object(a.c)(this.notifier,new a.a(n));return s&&!n.seenValue?(n.add(s),t.subscribe(n)):n}}class g extends a.b{constructor(e){super(e),this.seenValue=!1}notifyNext(){this.seenValue=!0,this.complete()}notifyComplete(){}}var d=n("lJxs"),l=function(e){return e[e.FetchChatHistory=1]="FetchChatHistory",e[e.SendMessage=2]="SendMessage",e}({}),h=n("SlXt"),b=n("itXk"),f=n("fXoL"),u=n("0tOT"),m=n("PvES"),p=n("DZuR"),M=n("Jgta"),y=n("a/YC"),C=n("N+D2");let O=(()=>{class e extends p.a{constructor(e,t,n){super(e,t),this.$overlay=n,this.databaseName="messageCenter"}fetchMessageRecord(e,t){const n=this.$overlay.startLoading(),s=document.activeElement;return s.blur(),new Promise(i=>{this.$fb.getDoc("messageCenter",e).collection("history").get().subscribe(e=>{this.$overlay.endLoading(n,s),i(e.docs.map(e=>e.data()).filter(({userId:e})=>e===t))})})}send(e,t,n){const s=this.$overlay.startLoading(),i=document.activeElement;return i.blur(),new Promise(o=>{this.$fb.getDoc("messageCenter",e).collection("history").add({message:t,isRead:!1,userId:n,sendTime:M.a.firestore.Timestamp.now()}).then(t=>{this.$logger.systemMessage(`message ${t.id} has successfully created.`),this.$fb.getDoc("messageCenter",e).collection("history").doc(t.id).update({id:t.id}).then(()=>{this.$overlay.endLoading(s,i),o(!0)})})})}}return e.\u0275fac=function(t){return new(t||e)(f.Rb(y.a),f.Rb(m.a),f.Rb(C.a))},e.\u0275prov=f.Eb({token:e,factory:e.\u0275fac,providedIn:"root"}),e})(),w=(()=>{class e extends u.a{constructor(e,t){super(e),this.$message=t,this.featureName="Chat"}resolveAction({action:e,id:t,friendId:n,message:s}){return new Promise(i=>{switch(e){case l.FetchChatHistory:this.$message.fetchMessageRecord(t,n).then(e=>{this.$logger.systemMessage(`Total ${e.length} messages with friend ${n} has successfully fetched.`),i(e)});break;case l.SendMessage:i(this.$message.send(t,s,n))}})}}return e.\u0275fac=function(t){return new(t||e)(f.Rb(m.a),f.Rb(O))},e.\u0275prov=f.Eb({token:e,factory:e.\u0275fac,providedIn:"root"}),e})();var P=n("LJo4"),v=n("3Pt+");let _=(()=>{class e{constructor(){}ngOnInit(){}}return e.\u0275fac=function(t){return new(t||e)},e.\u0275cmp=f.Cb({type:e,selectors:[["app-chat-announcement"]],decls:2,vars:0,template:function(e,t){1&e&&(f.Nb(0,"p"),f.mc(1,"chat-announcement works!"),f.Mb())},styles:["[_nghost-%COMP%]{display:block}"]}),e})();function x(e,t){1&e&&f.Jb(0,"app-chat-announcement")}function N(e,t){if(1&e&&(f.Nb(0,"div",15),f.Nb(1,"div",16),f.Jb(2,"img",17),f.Mb(),f.Nb(3,"div",18),f.Nb(4,"div"),f.Nb(5,"p"),f.mc(6),f.Mb(),f.Mb(),f.Mb(),f.Mb()),2&e){const e=f.Xb(3);f.yb(2),f.ac("src",e.friend.avatar,f.hc),f.yb(4),f.nc("item.message")}}function k(e,t){if(1&e&&(f.Nb(0,"div",19),f.Nb(1,"div",20),f.Nb(2,"p"),f.mc(3),f.Mb(),f.Mb(),f.Mb()),2&e){const e=f.Xb().$implicit;f.yb(3),f.nc(e.message)}}function $(e,t){if(1&e&&(f.Nb(0,"div",11),f.Lb(1,12),f.kc(2,N,7,2,"div",13),f.kc(3,k,4,1,"div",14),f.Kb(),f.Mb()),2&e){const e=t.$implicit,n=f.Xb(2);f.yb(1),f.ac("ngSwitch",e.userId),f.yb(1),f.ac("ngSwitchCase",n.userId),f.yb(1),f.ac("ngSwitchCase",n.friend.id)}}function I(e,t){if(1&e){const e=f.Ob();f.Lb(0),f.Nb(1,"header",2,3),f.Nb(3,"nav"),f.Nb(4,"h3"),f.mc(5),f.Mb(),f.Jb(6,"em"),f.Mb(),f.Nb(7,"nav"),f.Nb(8,"em",4),f.mc(9,"search"),f.Mb(),f.Nb(10,"em",4),f.mc(11,"content_paste"),f.Mb(),f.Mb(),f.kc(12,x,1,0,"app-chat-announcement",5),f.Mb(),f.Nb(13,"section"),f.kc(14,$,4,3,"div",6),f.Mb(),f.Nb(15,"footer",null,7),f.Nb(17,"textarea",8),f.Ub("ngModelChange",function(t){return f.fc(e),f.Xb().message=t})("keydown",function(t){return f.fc(e),f.Xb().afterKeydown(t)}),f.Mb(),f.Nb(18,"nav"),f.Nb(19,"div",9),f.Nb(20,"em",10),f.mc(21,"attach_file"),f.Mb(),f.Nb(22,"em",4),f.mc(23,"bookmark_border"),f.Mb(),f.Mb(),f.Mb(),f.Mb(),f.Kb()}if(2&e){const e=f.ec(2),t=f.ec(16),n=f.Xb();f.yb(5),f.nc(null==n.friend?null:n.friend.name),f.yb(7),f.ac("ngIf",!1),f.yb(1),f.jc("height","calc(100% - "+e.clientHeight+"px - "+t.clientHeight+"px)"),f.yb(1),f.ac("ngForOf",n.history),f.yb(3),f.ac("ngModel",n.message)}}function j(e,t){1&e&&(f.Nb(0,"section",21),f.Nb(1,"span",4),f.mc(2," question_answer "),f.Mb(),f.Nb(3,"p"),f.mc(4,"\u958b\u59cb\u804a\u5929\u5427!"),f.Mb(),f.Mb())}let S=(()=>{class e extends h.a{constructor(e,t,n){super(),this.$feature=e,this.$user=t,this.activatedRoute=n,this.message="",this.history=[],this.friend=null,this.userId=null}ngOnInit(){var e;this.$user.user$.pipe(Object(o.a)(1)).subscribe(e=>this.userId=e.id),Object(b.a)([this.$user.friends$.pipe(Object(c.a)(e=>e.length>0)),this.activatedRoute.params.pipe(Object(c.a)(({id:e})=>!!e))]).pipe((e=this.onDestroy$,t=>t.lift(new r(e))),Object(d.a)(([e,{id:t}])=>({friends:e,id:t}))).subscribe(({id:e,friends:t})=>this.initial(e,t))}afterKeydown(e){var t;"Enter"===e.key&&""!==this.message.trim()&&this.$feature.fireEvent({action:l.SendMessage,id:this.userId,message:this.message,friendId:null===(t=this.friend)||void 0===t?void 0:t.id}).then(()=>this.message="")}initial(e,t){this.friend=t.find(({id:t})=>t===e),this.$feature.fireEvent({action:l.FetchChatHistory,friendId:e,id:this.userId}).then(e=>{console.log("history",e),this.history=e})}}return e.\u0275fac=function(t){return new(t||e)(f.Ib(w),f.Ib(P.a),f.Ib(i.a))},e.\u0275cmp=f.Cb({type:e,selectors:[["app-chat"]],features:[f.vb],decls:3,vars:2,consts:[[4,"ngIf","ngIfElse"],["empty",""],[1,"w-100"],["tHeader",""],[1,"material-icons"],[4,"ngIf"],["class","message-group",4,"ngFor","ngForOf"],["tFooter",""],["placeholder","\u8acb\u8f38\u5165\u8a0a\u606f",1,"p-0",3,"ngModel","ngModelChange","keydown"],[1,"d-flex","flex-row","align-itmes-center"],["rotate45","",1,"material-icons"],[1,"message-group"],[3,"ngSwitch"],["class","message partner",4,"ngSwitchCase"],["class","message user",4,"ngSwitchCase"],[1,"message","partner"],[1,"message-left"],[3,"src"],[1,"message-right"],[1,"message","user"],[1,"item-group"],[1,"content-empty"]],template:function(e,t){if(1&e&&(f.kc(0,I,24,6,"ng-container",0),f.kc(1,j,5,0,"ng-template",null,1,f.lc)),2&e){const e=f.ec(2);f.ac("ngIf",t.friend)("ngIfElse",e)}},directives:[s.k,s.j,v.a,v.i,v.k,_,s.l,s.m],styles:["[_nghost-%COMP%]{display:block;height:100%}header[_ngcontent-%COMP%], nav[_ngcontent-%COMP%]{display:flex;flex-direction:row;align-items:center}header[_ngcontent-%COMP%]{justify-content:space-between;height:50px;padding:0 .8rem;position:relative}header[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{margin-right:.5rem;font-size:.875rem}app-chat-announcement[_ngcontent-%COMP%]{width:100%;position:absolute;top:50px;left:0;height:40px}section[_ngcontent-%COMP%]{overflow-y:auto;padding:0 12px}section[_ngcontent-%COMP%]   .message-group[_ngcontent-%COMP%]{display:block;width:100%;height:auto}section[_ngcontent-%COMP%]   .message-group[_ngcontent-%COMP%]   .message[_ngcontent-%COMP%]{display:flex;flex-direction:row;width:100%;height:auto;padding:5px 0}section[_ngcontent-%COMP%]   .message-group[_ngcontent-%COMP%]   .message.partner[_ngcontent-%COMP%]{justify-content:flex-start}section[_ngcontent-%COMP%]   .message-group[_ngcontent-%COMP%]   .message.partner[_ngcontent-%COMP%]   .message-left[_ngcontent-%COMP%]{width:50px;height:100%}section[_ngcontent-%COMP%]   .message-group[_ngcontent-%COMP%]   .message.partner[_ngcontent-%COMP%]   .message-left[_ngcontent-%COMP%]   img[_ngcontent-%COMP%]{width:37px;height:37px;border-radius:50%;object-fit:cover}section[_ngcontent-%COMP%]   .message-group[_ngcontent-%COMP%]   .message.partner[_ngcontent-%COMP%]   .message-right[_ngcontent-%COMP%]{display:flex;flex-direction:row;justify-content:flex-end;width:100%;height:auto;padding:5px 0}section[_ngcontent-%COMP%]   .message-group[_ngcontent-%COMP%]   .message.user[_ngcontent-%COMP%]{justify-content:flex-end}footer[_ngcontent-%COMP%]{border-top:1px solid #f5f5f5;padding:.9rem 1rem 0}footer[_ngcontent-%COMP%]   textarea[_ngcontent-%COMP%]{outline:none;display:block;width:100%;min-height:80px;max-height:140px;border:none;resize:none;font-size:.75rem}footer[_ngcontent-%COMP%]   textarea[_ngcontent-%COMP%]::placeholder{color:rgba(0,0,0,.2);font-size:.75rem}footer[_ngcontent-%COMP%]   nav[_ngcontent-%COMP%]{height:50px;padding:0 0 5px;display:flex;flex-direction:row;width:100%;justify-content:space-between}.content-empty[_ngcontent-%COMP%]{-webkit-user-select:none;user-select:none;display:flex;flex-direction:column;justify-content:center;align-items:center;width:100%;height:100%;color:#dbdfe5;background:#f9fcff}.content-empty[_ngcontent-%COMP%]   .material-icons[_ngcontent-%COMP%]{font-size:120px}.content-empty[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{font-size:20px}"]}),e})();const E=[{path:"",component:S},{path:":id",component:S}];let F=(()=>{class e{}return e.\u0275mod=f.Gb({type:e}),e.\u0275inj=f.Fb({factory:function(t){return new(t||e)},imports:[[i.e.forChild(E)],i.e]}),e})();var R=n("FpXt");let X=(()=>{class e{}return e.\u0275mod=f.Gb({type:e}),e.\u0275inj=f.Fb({factory:function(t){return new(t||e)},imports:[[R.a,s.c,F]]}),e})()}}]);