(window.webpackJsonp=window.webpackJsonp||[]).push([[7],{D7sm:function(e,t,n){"use strict";n.r(t),n.d(t,"ChatModule",function(){return K});var s=n("ofXK"),i=n("tyNb"),a=n("CmIU");n("phrh").e.get(a.f.Chat);var o=n("IzEk"),r=n("pLZG"),c=n("zx2A");function d(e){return t=>t.lift(new g(e))}class g{constructor(e){this.notifier=e}call(e,t){const n=new l(e),s=Object(c.c)(this.notifier,new c.a(n));return s&&!n.seenValue?(n.add(s),t.subscribe(n)):n}}class l extends c.b{constructor(e){super(e),this.seenValue=!1}notifyNext(){this.seenValue=!0,this.complete()}notifyComplete(){}}var h=n("lJxs"),f=function(e){return e[e.FetchChatHistory=1]="FetchChatHistory",e[e.ReadMessage=2]="ReadMessage",e[e.SendMessage=3]="SendMessage",e[e.CreateSocket=4]="CreateSocket",e[e.CloseSocket=5]="CloseSocket",e}({}),m=n("SlXt"),b=n("itXk"),p=n("fXoL"),u=n("quSY"),M=n("XNiG"),y=n("0tOT"),C=n("PvES"),_=n("/uUt"),v=n("cp0P"),O=n("DZuR"),w=n("Jgta"),x=n("a/YC"),P=n("N+D2");let k=(()=>{class e extends O.a{constructor(e,t,n){super(e,t),this.$overlay=n,this.databaseName="messageCenter"}onHistoryUpdated$(e){return this.$fb.getCollection(this.databaseName).doc(e).collection("history").valueChanges().pipe(Object(h.a)(e=>e),Object(_.a)((e,t)=>0===t.filter(({id:t,isRead:n})=>{var s;return t&&(!e.find(e=>e.id===t)||(null===(s=e.find(e=>e.id===t))||void 0===s?void 0:s.isRead)!==n)}).length))}fetchMessageRecord(e,t){const n=this.$overlay.startLoading(),s=document.activeElement;return s.blur(),new Promise(i=>{this.$fb.getDoc("messageCenter",e).collection("history").get().subscribe(e=>{this.$overlay.endLoading(n,s),i(e.docs.map(e=>e.data()).filter(({userId:e})=>e===t))})})}send(e,t,n){const s=this.$overlay.startLoading(),i=document.activeElement;return i.blur(),new Promise(a=>{this.$fb.getDoc("messageCenter",e).collection("history").add({message:t,isRead:!1,userId:n,sendTo:n,sendTime:w.a.firestore.Timestamp.now()}).then(t=>{this.$fb.getDoc("messageCenter",e).collection("history").doc(t.id).update({id:t.id}).then(()=>{this.$overlay.endLoading(s,i),a(t.id)})})})}sync(e,t,n,s){const i=this.$overlay.startLoading(),a=document.activeElement;return a.blur(),new Promise(o=>{this.$fb.getDoc("messageCenter",n).collection("history").doc(s).set({id:s,message:t,isRead:!1,userId:e,sendTo:n,sendTime:w.a.firestore.Timestamp.now()}).then(()=>{this.$overlay.endLoading(i,a),o(!0)})})}read(e,t){return new Promise(n=>{Object(v.a)(t.map(t=>this.$fb.getDoc("messageCenter",e).collection("history").doc(t).update({isRead:!0}))).subscribe(()=>n(!0))})}}return e.\u0275fac=function(t){return new(t||e)(p.Rb(x.a),p.Rb(C.a),p.Rb(P.a))},e.\u0275prov=p.Eb({token:e,factory:e.\u0275fac,providedIn:"root"}),e})(),$=(()=>{class e extends y.a{constructor(e,t){super(e),this.$message=t,this.ws=new u.a,this.messageHistory=new M.a,this.messageHistory$=this.messageHistory.asObservable(),this.featureName="Chat"}resolveAction({action:e,id:t,friendId:n,message:s,messageIds:i}){return new Promise(a=>{switch(e){case f.FetchChatHistory:this.$message.fetchMessageRecord(t,n).then(e=>{this.$logger.systemMessage(`Total ${history.length} messages with friend ${n} has successfully fetched.`),a(e)});break;case f.ReadMessage:this.readMessages(t,n,i);break;case f.SendMessage:a(this.addMessageRecord(t,n,s));break;case f.CreateSocket:this.$logger.systemMessage("chat ws has already created."),this.ws=this.$message.onHistoryUpdated$(t).subscribe(e=>{this.$logger.systemMessage(`Total ${e.length} messages with friend ${n} has successfully fetched.`),this.messageHistory.next(e.filter(({userId:e})=>e===n).sort((e,t)=>e.sendTime.toDate().toISOString()>t.sendTime.toDate().toISOString()?1:-1))});break;case f.CloseSocket:this.ws&&(this.ws.unsubscribe(),this.$logger.systemMessage("chat ws has already destroyed.")),a(!0)}})}readMessages(e,t,n){this.$message.read(e,n),this.$message.read(t,n)}addMessageRecord(e,t,n){return new Promise(s=>this.$message.send(e,n,t).then(i=>this.$message.sync(e,n,t,i).then(()=>s(!0))))}}return e.\u0275fac=function(t){return new(t||e)(p.Rb(C.a),p.Rb(k))},e.\u0275prov=p.Eb({token:e,factory:e.\u0275fac,providedIn:"root"}),e})();var I=n("LJo4"),T=n("3Pt+");let D=(()=>{class e{constructor(){}ngOnInit(){}}return e.\u0275fac=function(t){return new(t||e)},e.\u0275cmp=p.Cb({type:e,selectors:[["app-chat-announcement"]],decls:2,vars:0,template:function(e,t){1&e&&(p.Nb(0,"p"),p.mc(1,"chat-announcement works!"),p.Mb())},styles:["[_nghost-%COMP%]{display:block}"]}),e})(),N=(()=>{class e{transform(e){const t=Array.from(e.toDate().toLocaleTimeString().replace(/:\d{1,2}/,""));return t.splice(2,0," "),t.join("")}}return e.\u0275fac=function(t){return new(t||e)},e.\u0275pipe=p.Hb({name:"chatTime",type:e,pure:!0}),e})(),S=(()=>{class e{transform(e){const t=e.toDate();let n="";switch(t.getDay()){case 0:n="\u65e5";break;case 1:n="\u4e00";break;case 2:n="\u4e8c";break;case 3:n="\u4e09";break;case 4:n="\u56db";break;case 5:n="\u4e94";break;case 6:n="\u516d"}const s=t.toLocaleDateString().replace(/^\d{1,2}:/,"").split("/");return s.shift(),this.isToday(t)?"\u4eca\u5929":this.isYestday(t)?"\u6628\u5929":`${s[0]}\u6708${s[1]}\u65e5(${n})`}isToday(e){return e.getDate()===(new Date).getDate()}isYestday(e){const t=new Date;return t!==e&&new Date(t.getTime()-864e5).getDate()===e.getDate()}}return e.\u0275fac=function(t){return new(t||e)},e.\u0275pipe=p.Hb({name:"chatDate",type:e,pure:!0}),e})();const R=["tMessages"];function H(e,t){1&e&&p.Jb(0,"app-chat-announcement")}function j(e,t){if(1&e&&(p.Nb(0,"li",21),p.Nb(1,"p"),p.mc(2),p.Yb(3,"chatDate"),p.Mb(),p.Mb()),2&e){const e=p.Xb().$implicit;p.yb(2),p.nc(p.Zb(3,1,e.sendTime))}}function L(e,t){if(1&e&&p.Jb(0,"img",22),2&e){const e=p.Xb(3);p.ac("src",e.friend.avatar||e.defaultAvatar,p.hc)}}function E(e,t){1&e&&(p.Nb(0,"p"),p.mc(1,"\u5df2\u8b80"),p.Mb())}function z(e,t){if(1&e&&(p.Lb(0),p.kc(1,j,4,3,"li",13),p.Nb(2,"li",14),p.Nb(3,"div",15),p.kc(4,L,1,1,"img",16),p.Mb(),p.Nb(5,"div",17),p.Nb(6,"p",18),p.mc(7),p.Mb(),p.Nb(8,"div",19),p.kc(9,E,2,0,"p",5),p.Nb(10,"p",20),p.mc(11),p.Yb(12,"chatTime"),p.Mb(),p.Mb(),p.Mb(),p.Mb(),p.Kb()),2&e){const e=t.$implicit,n=t.index,s=p.Xb(2);p.yb(1),p.ac("ngIf",s.showDateDivider(s.messageHistory,n,e)),p.yb(1),p.Ab("message__myself",e.sendTo!==s.userId)("message__friend",e.sendTo===s.userId),p.yb(2),p.ac("ngIf",s.showAvatar(s.messageHistory,n,e)),p.yb(3),p.nc(e.message),p.yb(2),p.ac("ngIf",e.isRead&&e.sendTo!==s.userId),p.yb(2),p.nc(p.Zb(12,9,e.sendTime))}}function X(e,t){if(1&e){const e=p.Ob();p.Lb(0),p.Nb(1,"header",2,3),p.Nb(3,"nav"),p.Nb(4,"h3"),p.mc(5),p.Mb(),p.Jb(6,"em"),p.Mb(),p.Nb(7,"nav"),p.Nb(8,"em",4),p.mc(9,"search"),p.Mb(),p.Nb(10,"em",4),p.mc(11,"content_paste"),p.Mb(),p.Mb(),p.kc(12,H,1,0,"app-chat-announcement",5),p.Mb(),p.Nb(13,"section",6),p.Nb(14,"ul",2,7),p.kc(16,z,13,11,"ng-container",8),p.Mb(),p.Mb(),p.Nb(17,"footer",null,9),p.Nb(19,"textarea",10),p.Ub("ngModelChange",function(t){return p.fc(e),p.Xb().message=t})("keydown",function(t){return p.fc(e),p.Xb().afterKeydown(t)}),p.Mb(),p.Nb(20,"nav"),p.Nb(21,"div",11),p.Nb(22,"em",12),p.mc(23,"attach_file"),p.Mb(),p.Nb(24,"em",4),p.mc(25,"bookmark_border"),p.Mb(),p.Mb(),p.Mb(),p.Mb(),p.Kb()}if(2&e){const e=p.ec(2),t=p.ec(18),n=p.Xb();p.yb(5),p.nc(null==n.friend?null:n.friend.name),p.yb(7),p.ac("ngIf",!1),p.yb(1),p.jc("height","calc(100% - "+e.clientHeight+"px - "+t.clientHeight+"px)"),p.ac("scrollTop",n.scrollTop),p.yb(3),p.ac("ngForOf",n.messageHistory),p.yb(3),p.ac("ngModel",n.message)}}function A(e,t){1&e&&(p.Nb(0,"section",23),p.Nb(1,"span",4),p.mc(2," question_answer "),p.Mb(),p.Nb(3,"p"),p.mc(4,"\u958b\u59cb\u804a\u5929\u5427!"),p.Mb(),p.Mb())}let F=(()=>{class e extends m.a{constructor(e,t,n){super(),this.$feature=e,this.$user=t,this.activatedRoute=n,this.message="",this.friend=null,this.userId=null,this.messageHistory=[],this.defaultAvatar="assets/images/icons/empty-avatar.jpeg",this.scrollTop=0}ngOnInit(){this.$user.user$.pipe(Object(o.a)(1)).subscribe(e=>this.userId=e.id),Object(b.a)([this.$user.friends$.pipe(Object(r.a)(e=>e.length>0)),this.activatedRoute.params.pipe(Object(r.a)(({id:e})=>!!e))]).pipe(d(this.onDestroy$),Object(h.a)(([e,{id:t}])=>({friends:e,id:t}))).subscribe(({id:e,friends:t})=>this.initial(e,t)),this.$feature.messageHistory$.pipe(d(this.onDestroy$)).subscribe(e=>this.afterMessageHistoriesUpdated(e))}showAvatar(e,t,n){return(0===t||e[t].sendTime.toDate().toISOString().split(":")[1]!==e[t-1].sendTime.toDate().toISOString().split(":")[1])&&n.sendTo===this.userId}showDateDivider(e,t,n){return 0===t||n.sendTime.toDate().toLocaleDateString()!==e[t-1].sendTime.toDate().toLocaleDateString()}afterKeydown(e){var t;"Enter"===e.key&&""!==this.message.trim()&&this.$feature.fireEvent({action:f.SendMessage,id:this.userId,friendId:null===(t=this.friend)||void 0===t?void 0:t.id,message:this.message}).then(()=>this.message="")}afterMessageHistoriesUpdated(e){var t,n;switch(this.messageHistory=e,null===(t=e[e.length-1])||void 0===t?void 0:t.sendTo){case this.userId:this.markMessageAsRead(e.filter(({sendTo:e})=>e===this.userId).map(({id:e})=>e));break;case null===(n=this.friend)||void 0===n?void 0:n.id:setTimeout(()=>this.scrollToLastMessage.bind(this),0)}}initial(e,t){this.friend=t.find(({id:t})=>t===e),this.$feature.fireEvent({action:f.CloseSocket}).then(()=>{this.$feature.fireEvent({action:f.CreateSocket,id:this.userId,friendId:e})})}markMessageAsRead(e){var t;this.$feature.fireEvent({action:f.ReadMessage,id:this.userId,friendId:null===(t=this.friend)||void 0===t?void 0:t.id,messageIds:e})}scrollToLastMessage(){var e;this.scrollTop=(null===(e=this.tMessages)||void 0===e?void 0:e.nativeElement).clientHeight}}return e.\u0275fac=function(t){return new(t||e)(p.Ib($),p.Ib(I.a),p.Ib(i.a))},e.\u0275cmp=p.Cb({type:e,selectors:[["app-chat"]],viewQuery:function(e,t){if(1&e&&p.qc(R,!0),2&e){let e;p.dc(e=p.Vb())&&(t.tMessages=e.first)}},features:[p.vb],decls:3,vars:2,consts:[[4,"ngIf","ngIfElse"],["empty",""],[1,"w-100"],["tHeader",""],[1,"material-icons"],[4,"ngIf"],[3,"scrollTop"],["tMessages",""],[4,"ngFor","ngForOf"],["tFooter",""],["placeholder","\u8acb\u8f38\u5165\u8a0a\u606f",1,"p-0",3,"ngModel","ngModelChange","keydown"],[1,"d-flex","flex-row","align-itmes-center"],["rotate45","",1,"material-icons"],["class","date-divider",4,"ngIf"],[1,"message"],[1,"avatar"],["alt","",3,"src",4,"ngIf"],[1,"content"],[1,"text"],[1,"caption"],[1,"time"],[1,"date-divider"],["alt","",3,"src"],[1,"content-empty"]],template:function(e,t){if(1&e&&(p.kc(0,X,26,7,"ng-container",0),p.kc(1,A,5,0,"ng-template",null,1,p.lc)),2&e){const e=p.ec(2);p.ac("ngIf",t.friend)("ngIfElse",e)}},directives:[s.k,s.j,T.a,T.i,T.k,D],pipes:[N,S],styles:['[_nghost-%COMP%]{display:block;height:100%}header[_ngcontent-%COMP%], nav[_ngcontent-%COMP%]{display:flex;flex-direction:row;align-items:center}header[_ngcontent-%COMP%]{justify-content:space-between;height:50px;padding:0 .8rem;position:relative}header[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{margin-right:.5rem;font-size:.875rem}app-chat-announcement[_ngcontent-%COMP%]{width:100%;position:absolute;top:50px;left:0;height:40px}footer[_ngcontent-%COMP%]{border-top:1px solid #f5f5f5;padding:.9rem 1rem 0}footer[_ngcontent-%COMP%]   textarea[_ngcontent-%COMP%]{outline:none;display:block;width:100%;min-height:80px;max-height:140px;border:none;resize:none;font-size:.75rem}footer[_ngcontent-%COMP%]   textarea[_ngcontent-%COMP%]::placeholder{color:rgba(0,0,0,.2);font-size:.75rem}footer[_ngcontent-%COMP%]   nav[_ngcontent-%COMP%]{height:50px;padding:0 0 5px;display:flex;flex-direction:row;width:100%;justify-content:space-between}.content-empty[_ngcontent-%COMP%]{-webkit-user-select:none;user-select:none;display:flex;flex-direction:column;justify-content:center;align-items:center;width:100%;height:100%;color:#d0d5db;background:#f2f6f8}.content-empty[_ngcontent-%COMP%]   .material-icons[_ngcontent-%COMP%]{font-size:120px}.content-empty[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{font-size:20px}section[_ngcontent-%COMP%]{overflow-y:auto;padding:0 12px}.date-divider[_ngcontent-%COMP%]{display:flex;justify-content:center;align-items:center}.date-divider[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{padding:6px 12px;font-size:.75rem;color:#afb1b5;background-color:#f2f6f8;border-radius:11px}.message[_ngcontent-%COMP%]{align-items:center;margin-right:15px;padding:10px 0;font-size:.875rem}.message[_ngcontent-%COMP%], .message[_ngcontent-%COMP%]   .content[_ngcontent-%COMP%]{display:flex;flex-direction:row}.message[_ngcontent-%COMP%]   .content[_ngcontent-%COMP%]{position:relative;align-items:flex-end}.message[_ngcontent-%COMP%]   .content[_ngcontent-%COMP%]:before{content:"";position:absolute;z-index:10;top:50px;right:0;width:10px;height:10px;background-color:#539cf0;transform:rotate(45deg)}.message[_ngcontent-%COMP%]   .text[_ngcontent-%COMP%]{margin:4px 0;padding:10px 9px;word-wrap:break-word;border-radius:16px}.message[_ngcontent-%COMP%]   .caption[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-items:flex-start;padding:0 7px;font-size:.75rem;color:#afb1b5;white-space:nowrap}.message[_ngcontent-%COMP%]   .time[_ngcontent-%COMP%]{padding:3px 0}.message__myself[_ngcontent-%COMP%]{justify-content:flex-end}.message__myself[_ngcontent-%COMP%]   .content[_ngcontent-%COMP%]{flex-direction:row-reverse}.message__myself[_ngcontent-%COMP%]   .caption[_ngcontent-%COMP%]{align-items:flex-end}.message__myself[_ngcontent-%COMP%]   .text[_ngcontent-%COMP%]{background:#a3cdfd}.message__friend[_ngcontent-%COMP%]{justify-content:flex-start;align-items:flex-end}.message__friend[_ngcontent-%COMP%]   .text[_ngcontent-%COMP%]{display:flex;background:#e9ebec}.message__friend[_ngcontent-%COMP%]   .avatar[_ngcontent-%COMP%]{width:41px;margin-right:10px}.message__friend[_ngcontent-%COMP%]   .avatar[_ngcontent-%COMP%]   img[_ngcontent-%COMP%]{width:41px;height:41px;border-radius:50%;object-fit:cover}.message__friend[_ngcontent-%COMP%]   .caption[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]:first-child{display:none}']}),e})();const J=[{path:"",component:F},{path:":id",component:F}];let U=(()=>{class e{}return e.\u0275mod=p.Gb({type:e}),e.\u0275inj=p.Fb({factory:function(t){return new(t||e)},imports:[[i.e.forChild(J)],i.e]}),e})();var Y=n("FpXt");let K=(()=>{class e{}return e.\u0275mod=p.Gb({type:e}),e.\u0275inj=p.Fb({factory:function(t){return new(t||e)},imports:[[Y.a,s.c,U]]}),e})()}}]);