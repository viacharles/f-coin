(window.webpackJsonp=window.webpackJsonp||[]).push([[7],{D7sm:function(e,t,n){"use strict";n.r(t),n.d(t,"ChatModule",function(){return D});var s=n("ofXK"),i=n("tyNb"),o=n("IzEk"),a=n("pLZG"),r=n("zx2A");class c{constructor(e){this.notifier=e}call(e,t){const n=new d(e),s=Object(r.c)(this.notifier,new r.a(n));return s&&!n.seenValue?(n.add(s),t.subscribe(n)):n}}class d extends r.b{constructor(e){super(e),this.seenValue=!1}notifyNext(){this.seenValue=!0,this.complete()}notifyComplete(){}}var l=n("lJxs"),g=function(e){return e[e.FetchChatHistory=1]="FetchChatHistory",e[e.SendMessage=2]="SendMessage",e[e.CreateSocket=3]="CreateSocket",e[e.CloseSocket=4]="CloseSocket",e}({}),f=n("SlXt"),h=n("itXk"),b=n("fXoL"),u=n("quSY"),m=n("XNiG"),p=n("0tOT"),y=n("PvES"),M=n("/uUt"),C=n("DZuR"),w=n("Jgta"),_=n("a/YC"),O=n("N+D2");let v=(()=>{class e extends C.a{constructor(e,t,n){super(e,t),this.$overlay=n,this.databaseName="messageCenter"}onHistoryUpdated$(e){return this.$fb.getCollection(this.databaseName).doc(e).collection("history").valueChanges().pipe(Object(l.a)(e=>e),Object(M.a)((e,t)=>0===t.filter(({id:t})=>t&&!e.find(e=>e.id===t)).length))}fetchMessageRecord(e,t){const n=this.$overlay.startLoading(),s=document.activeElement;return s.blur(),new Promise(i=>{this.$fb.getDoc("messageCenter",e).collection("history").get().subscribe(e=>{this.$overlay.endLoading(n,s),i(e.docs.map(e=>e.data()).filter(({userId:e})=>e===t))})})}send(e,t,n,s){const i=this.$overlay.startLoading(),o=document.activeElement;return o.blur(),new Promise(a=>{this.$fb.getDoc("messageCenter",e).collection("history").add({message:t,isRead:!1,userId:n,sendTo:s,sendTime:w.a.firestore.Timestamp.now()}).then(t=>{this.$fb.getDoc("messageCenter",e).collection("history").doc(t.id).update({id:t.id}).then(()=>{this.$overlay.endLoading(i,o),a(!0)})})})}}return e.\u0275fac=function(t){return new(t||e)(b.Rb(_.a),b.Rb(y.a),b.Rb(O.a))},e.\u0275prov=b.Eb({token:e,factory:e.\u0275fac,providedIn:"root"}),e})(),x=(()=>{class e extends p.a{constructor(e,t){super(e),this.$message=t,this.ws=new u.a,this.messageHistory=new m.a,this.messageHistory$=this.messageHistory.asObservable(),this.featureName="Chat"}resolveAction({action:e,id:t,friendId:n,message:s}){return new Promise(i=>{switch(e){case g.FetchChatHistory:this.$message.fetchMessageRecord(t,n).then(e=>{this.$logger.systemMessage(`Total ${e.length} messages with friend ${n} has successfully fetched.`),i(e)});break;case g.SendMessage:i(this.addMessageRecord(t,n,s));break;case g.CreateSocket:this.$logger.systemMessage("chat ws has already created."),this.ws=this.$message.onHistoryUpdated$(t).subscribe(e=>{this.$logger.systemMessage(`Total ${e.length} messages with friend ${n} has successfully fetched.`),this.messageHistory.next(e.filter(({userId:e})=>e===n).sort((e,t)=>e.sendTime.toDate().toISOString()>t.sendTime.toDate().toISOString()?1:-1))});break;case g.CloseSocket:this.ws&&(this.ws.unsubscribe(),this.$logger.systemMessage("chat ws has already destroyed.")),i(!0)}})}addMessageRecord(e,t,n){return new Promise(s=>Promise.all([this.$message.send(e,n,t,t),this.$message.send(t,n,e,t)]).then(()=>s(!0)))}}return e.\u0275fac=function(t){return new(t||e)(b.Rb(y.a),b.Rb(v))},e.\u0275prov=b.Eb({token:e,factory:e.\u0275fac,providedIn:"root"}),e})();var $=n("LJo4"),k=n("3Pt+");let I=(()=>{class e{constructor(){}ngOnInit(){}}return e.\u0275fac=function(t){return new(t||e)},e.\u0275cmp=b.Cb({type:e,selectors:[["app-chat-announcement"]],decls:2,vars:0,template:function(e,t){1&e&&(b.Nb(0,"p"),b.mc(1,"chat-announcement works!"),b.Mb())},styles:["[_nghost-%COMP%]{display:block}"]}),e})();function P(e,t){1&e&&b.Jb(0,"app-chat-announcement")}function N(e,t){if(1&e&&b.Jb(0,"img",14),2&e){const e=b.Xb(4);b.ac("src",e.friend.avatar,b.hc)}}function S(e,t){if(1&e&&(b.Nb(0,"li",12),b.kc(1,N,1,1,"img",13),b.Nb(2,"p"),b.mc(3),b.Mb(),b.Mb()),2&e){const e=t.$implicit,n=b.Xb(3);b.Ab("message__myself",e.sendTo!==n.userId)("message__friend",e.sendTo===n.userId),b.yb(1),b.ac("ngIf",e.sendTo===n.userId),b.yb(2),b.nc(e.message)}}function j(e,t){if(1&e&&(b.Nb(0,"section"),b.Nb(1,"ul",2),b.kc(2,S,4,6,"li",11),b.Mb(),b.Mb()),2&e){const e=t.ngIf;b.Xb();const n=b.ec(2),s=b.ec(16);b.jc("height","calc(100% - "+n.clientHeight+"px - "+s.clientHeight+"px)"),b.yb(2),b.ac("ngForOf",e)}}function H(e,t){if(1&e){const e=b.Ob();b.Lb(0),b.Nb(1,"header",2,3),b.Nb(3,"nav"),b.Nb(4,"h3"),b.mc(5),b.Mb(),b.Jb(6,"em"),b.Mb(),b.Nb(7,"nav"),b.Nb(8,"em",4),b.mc(9,"search"),b.Mb(),b.Nb(10,"em",4),b.mc(11,"content_paste"),b.Mb(),b.Mb(),b.kc(12,P,1,0,"app-chat-announcement",5),b.Mb(),b.kc(13,j,3,3,"section",6),b.Yb(14,"async"),b.Nb(15,"footer",null,7),b.Nb(17,"textarea",8),b.Ub("ngModelChange",function(t){return b.fc(e),b.Xb().message=t})("keydown",function(t){return b.fc(e),b.Xb().afterKeydown(t)}),b.Mb(),b.Nb(18,"nav"),b.Nb(19,"div",9),b.Nb(20,"em",10),b.mc(21,"attach_file"),b.Mb(),b.Nb(22,"em",4),b.mc(23,"bookmark_border"),b.Mb(),b.Mb(),b.Mb(),b.Mb(),b.Kb()}if(2&e){const e=b.Xb();b.yb(5),b.nc(null==e.friend?null:e.friend.name),b.yb(7),b.ac("ngIf",!1),b.yb(1),b.ac("ngIf",b.Zb(14,4,e.$feature.messageHistory$)),b.yb(4),b.ac("ngModel",e.message)}}function R(e,t){1&e&&(b.Nb(0,"section",15),b.Nb(1,"span",4),b.mc(2," question_answer "),b.Mb(),b.Nb(3,"p"),b.mc(4,"\u958b\u59cb\u804a\u5929\u5427!"),b.Mb(),b.Mb())}let E=(()=>{class e extends f.a{constructor(e,t,n){super(),this.$feature=e,this.$user=t,this.activatedRoute=n,this.message="",this.friend=null,this.userId=null}ngOnInit(){var e;this.$user.user$.pipe(Object(o.a)(1)).subscribe(e=>this.userId=e.id),Object(h.a)([this.$user.friends$.pipe(Object(a.a)(e=>e.length>0)),this.activatedRoute.params.pipe(Object(a.a)(({id:e})=>!!e))]).pipe((e=this.onDestroy$,t=>t.lift(new c(e))),Object(l.a)(([e,{id:t}])=>({friends:e,id:t}))).subscribe(({id:e,friends:t})=>this.initial(e,t))}afterKeydown(e){var t;"Enter"===e.key&&""!==this.message.trim()&&this.$feature.fireEvent({action:g.SendMessage,id:this.userId,friendId:null===(t=this.friend)||void 0===t?void 0:t.id,message:this.message}).then(()=>this.message="")}initial(e,t){this.friend=t.find(({id:t})=>t===e),this.$feature.fireEvent({action:g.CloseSocket}).then(()=>{this.$feature.fireEvent({action:g.CreateSocket,id:this.userId,friendId:e})})}}return e.\u0275fac=function(t){return new(t||e)(b.Ib(x),b.Ib($.a),b.Ib(i.a))},e.\u0275cmp=b.Cb({type:e,selectors:[["app-chat"]],features:[b.vb],decls:3,vars:2,consts:[[4,"ngIf","ngIfElse"],["empty",""],[1,"w-100"],["tHeader",""],[1,"material-icons"],[4,"ngIf"],[3,"height",4,"ngIf"],["tFooter",""],["placeholder","\u8acb\u8f38\u5165\u8a0a\u606f",1,"p-0",3,"ngModel","ngModelChange","keydown"],[1,"d-flex","flex-row","align-itmes-center"],["rotate45","",1,"material-icons"],["class","message",3,"message__myself","message__friend",4,"ngFor","ngForOf"],[1,"message"],["alt","",3,"src",4,"ngIf"],["alt","",3,"src"],[1,"content-empty"]],template:function(e,t){if(1&e&&(b.kc(0,H,24,6,"ng-container",0),b.kc(1,R,5,0,"ng-template",null,1,b.lc)),2&e){const e=b.ec(2);b.ac("ngIf",t.friend)("ngIfElse",e)}},directives:[s.k,k.a,k.i,k.k,I,s.j],pipes:[s.b],styles:["[_nghost-%COMP%]{display:block;height:100%}header[_ngcontent-%COMP%], nav[_ngcontent-%COMP%]{display:flex;flex-direction:row;align-items:center}header[_ngcontent-%COMP%]{justify-content:space-between;height:50px;padding:0 .8rem;position:relative}header[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{margin-right:.5rem;font-size:.875rem}app-chat-announcement[_ngcontent-%COMP%]{width:100%;position:absolute;top:50px;left:0;height:40px}footer[_ngcontent-%COMP%]{border-top:1px solid #f5f5f5;padding:.9rem 1rem 0}footer[_ngcontent-%COMP%]   textarea[_ngcontent-%COMP%]{outline:none;display:block;width:100%;min-height:80px;max-height:140px;border:none;resize:none;font-size:.75rem}footer[_ngcontent-%COMP%]   textarea[_ngcontent-%COMP%]::placeholder{color:rgba(0,0,0,.2);font-size:.75rem}footer[_ngcontent-%COMP%]   nav[_ngcontent-%COMP%]{height:50px;padding:0 0 5px;display:flex;flex-direction:row;width:100%;justify-content:space-between}.content-empty[_ngcontent-%COMP%]{-webkit-user-select:none;user-select:none;display:flex;flex-direction:column;justify-content:center;align-items:center;width:100%;height:100%;color:#dbdfe5;background:#f9fcff}.content-empty[_ngcontent-%COMP%]   .material-icons[_ngcontent-%COMP%]{font-size:120px}.content-empty[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{font-size:20px}section[_ngcontent-%COMP%]{overflow-y:auto}.message[_ngcontent-%COMP%]{display:flex;flex-direction:row;align-items:center}.message__myself[_ngcontent-%COMP%]{justify-content:flex-end}.message__friend[_ngcontent-%COMP%]{justify-content:flex-start}.message__friend[_ngcontent-%COMP%]   img[_ngcontent-%COMP%]{width:37px;height:37px;border-radius:50%;object-fit:cover}"]}),e})();const X=[{path:"",component:E},{path:":id",component:E}];let T=(()=>{class e{}return e.\u0275mod=b.Gb({type:e}),e.\u0275inj=b.Fb({factory:function(t){return new(t||e)},imports:[[i.e.forChild(X)],i.e]}),e})();var F=n("FpXt");let D=(()=>{class e{}return e.\u0275mod=b.Gb({type:e}),e.\u0275inj=b.Fb({factory:function(t){return new(t||e)},imports:[[F.a,s.c,T]]}),e})()}}]);