(window.webpackJsonp=window.webpackJsonp||[]).push([[7],{D7sm:function(e,t,n){"use strict";n.r(t),n.d(t,"ChatModule",function(){return L});var o=n("ofXK"),i=n("tyNb"),s=n("IzEk"),r=n("pLZG"),a=n("vkgz"),c=n("1G5W"),l=n("lJxs"),d=n("HpAP"),g=n("itXk"),p=n("kb6m"),f=n("pfiL"),b=n("fXoL"),u=n("f/Kl"),h=n("LJo4"),m=n("vsUh"),O=n("3Pt+");let y=(()=>{class e{constructor(){}ngOnInit(){}}return e.\u0275fac=function(t){return new(t||e)},e.\u0275cmp=b.Db({type:e,selectors:[["app-chat-announcement"]],decls:2,vars:0,template:function(e,t){1&e&&(b.Ob(0,"p"),b.pc(1,"chat-announcement works!"),b.Nb())},styles:["[_nghost-%COMP%]{display:block}"]}),e})(),x=(()=>{class e{constructor(){this.debounceTime=.4,this.scrollEnd=new b.n,this.scrolling=new b.n}scroll(e){this.isScrolling(e),this.isScrollEnd()}isScrollEnd(){this.scrollEndTimer&&clearTimeout(this.scrollEndTimer),this.scrollEndTimer=setTimeout(()=>this.scrollEnd.emit(),1e3*this.debounceTime)}isScrolling(e){this.scrolling.emit(e)}}return e.\u0275fac=function(t){return new(t||e)},e.\u0275dir=b.Eb({type:e,selectors:[["","appScrollControl",""]],hostBindings:function(e,t){1&e&&b.Vb("scroll",function(e){return t.scroll(e)})},inputs:{debounceTime:"debounceTime"},outputs:{scrollEnd:"scrollEnd",scrolling:"scrolling"}}),e})(),_=(()=>{class e{transform(e){return e.toDate().toLocaleTimeString().replace(/[:]\d{2}$/,"")}}return e.\u0275fac=function(t){return new(t||e)},e.\u0275pipe=b.Ib({name:"chatTime",type:e,pure:!0}),e})(),M=(()=>{class e{transform(e){if(e){const t=e.toDate(),n=t.toLocaleDateString().split("/");let o="";switch(t.getDay()){case 0:o="\u65e5";break;case 1:o="\u4e00";break;case 2:o="\u4e8c";break;case 3:o="\u4e09";break;case 4:o="\u56db";break;case 5:o="\u4e94";break;case 6:o="\u516d"}return this.isToday(t)?"\u4eca\u5929":this.isYestday(t)?"\u6628\u5929":this.isOtherYear(t)?`${n[0]}.${n[1]}.${n[2]}`:`${n[1]}\u6708${n[2]}\u65e5(${o})`}return""}isToday(e){return e.toDateString()===(new Date).toDateString()}isYestday(e){const t=new Date;return!this.isToday(e)&&new Date(t.getTime()-864e5).toDateString()===e.toDateString()}isOtherYear(e){return e.getFullYear()!==(new Date).getFullYear()}}return e.\u0275fac=function(t){return new(t||e)},e.\u0275pipe=b.Ib({name:"chatDate",type:e,pure:!0}),e})();const v=["tMessages"],C=["tDateBuoy"],w=["tDateDividers"];function P(e,t){1&e&&b.Kb(0,"app-chat-announcement")}function D(e,t){if(1&e&&(b.Ob(0,"div",17,18),b.pc(2),b.Nb()),2&e){const e=b.Yb(3);b.mc("left",e.dateBuoyLeft),b.Bb("fade-out",e.isScrollStop)("fade-in",!e.isScrollStop),b.yb(2),b.rc(" ",e.dateBuoyValue," ")}}function T(e,t){if(1&e&&(b.Ob(0,"li",27),b.Ob(1,"p",null,28),b.pc(3),b.Zb(4,"chatDate"),b.Nb(),b.Nb()),2&e){const e=b.Yb().$implicit;b.yb(3),b.qc(b.ac(4,1,e.sendTime))}}function S(e,t){if(1&e&&b.Kb(0,"img",29),2&e){const e=b.Yb(4);b.dc("src",e.friend.avatar||e.defaultAvatar,b.kc)}}function k(e,t){1&e&&(b.Ob(0,"p"),b.pc(1,"\u5df2\u8b80"),b.Nb())}function I(e,t){1&e&&b.Kb(0,"span")}function N(e,t){if(1&e&&(b.Mb(0),b.nc(1,T,5,3,"li",19),b.Ob(2,"li",20),b.Ob(3,"div",21),b.nc(4,S,1,1,"img",22),b.Nb(),b.Ob(5,"div",23),b.Ob(6,"p",24),b.pc(7),b.Nb(),b.Ob(8,"div",25),b.nc(9,k,2,0,"p",5),b.Ob(10,"p",26),b.pc(11),b.Zb(12,"chatTime"),b.Nb(),b.Nb(),b.nc(13,I,1,0,"span",5),b.Nb(),b.Nb(),b.Lb()),2&e){const e=t.$implicit,n=t.index,o=b.Yb(3);b.yb(1),b.dc("ngIf",o.showDateDivider(o.messageHistory,n,e)),b.yb(1),b.Bb("message__myself",e.sendTo!==o.userId)("message__friend",e.sendTo===o.userId)("subMessage",o.isAppendage(o.messageHistory,n,e)),b.yb(2),b.dc("ngIf",o.showAvatar(o.messageHistory,n,e)),b.yb(3),b.qc(e.message),b.yb(2),b.dc("ngIf",e.isRead&&e.sendTo!==o.userId),b.yb(2),b.qc(o.hideTime(o.messageHistory,n,e)?"":b.ac(12,12,e.sendTime)),b.yb(2),b.dc("ngIf",!o.isAppendage(o.messageHistory,n,e))}}function $(e,t){if(1&e){const e=b.Pb();b.Ob(0,"section",11,12),b.Vb("scrolling",function(){b.ic(e);const t=b.hc(1);return b.Yb(2).onScroll(t)})("scrollEnd",function(){return b.ic(e),b.Yb(2).onScrollEnd()}),b.nc(2,D,3,7,"div",13),b.Ob(3,"ul",2,14),b.nc(5,N,14,14,"ng-container",15),b.Nb(),b.Ob(6,"button",16),b.Vb("click",function(){b.ic(e);const t=b.hc(1),n=b.hc(4);return b.Yb(2).scrollToBottom(t,n)}),b.Ob(7,"span",4),b.pc(8," arrow_downward "),b.Nb(),b.Nb(),b.Nb()}if(2&e){b.Yb();const e=b.hc(2),t=b.hc(16),n=b.Yb();b.mc("height","calc(100% - "+e.clientHeight+"px - "+t.clientHeight+"px)"),b.dc("scrollTop",n.scrollTop),b.yb(2),b.dc("ngIf",n.dateBuoyValue&&!n.isScrollToBottom),b.yb(3),b.dc("ngForOf",n.messageHistory),b.yb(1),b.Bb("fade-down-out",n.isScrollToBottom)}}function E(e,t){if(1&e){const e=b.Pb();b.Mb(0),b.Ob(1,"header",2,3),b.Ob(3,"nav"),b.Ob(4,"h3"),b.pc(5),b.Nb(),b.Kb(6,"em"),b.Nb(),b.Ob(7,"nav"),b.Ob(8,"em",4),b.pc(9,"search"),b.Nb(),b.Ob(10,"em",4),b.pc(11,"content_paste"),b.Nb(),b.Nb(),b.nc(12,P,1,0,"app-chat-announcement",5),b.Nb(),b.nc(13,$,9,7,"section",6),b.Zb(14,"async"),b.Ob(15,"footer",null,7),b.Ob(17,"textarea",8),b.Vb("ngModelChange",function(t){return b.ic(e),b.Yb().message=t})("keydown",function(t){return b.ic(e),b.Yb().afterKeydown(t)}),b.Nb(),b.Ob(18,"nav"),b.Ob(19,"div",9),b.Ob(20,"em",10),b.pc(21,"attach_file"),b.Nb(),b.Ob(22,"em",4),b.pc(23,"bookmark_border"),b.Nb(),b.Nb(),b.Nb(),b.Nb(),b.Lb()}if(2&e){const e=b.Yb();b.yb(5),b.qc(null==e.friend?null:e.friend.name),b.yb(7),b.dc("ngIf",!1),b.yb(1),b.dc("ngIf",b.ac(14,4,e.$user.user$)),b.yb(4),b.dc("ngModel",e.message)}}function B(e,t){1&e&&(b.Ob(0,"section",30),b.Ob(1,"span",4),b.pc(2," question_answer "),b.Nb(),b.Ob(3,"p"),b.pc(4,"\u958b\u59cb\u804a\u5929\u5427!"),b.Nb(),b.Nb())}let Y=(()=>{class e extends f.a{constructor(e,t,n,o){super(),this.$feature=e,this.$user=t,this.$window=n,this.activatedRoute=o,this.message="",this.messageHistory=[],this.defaultAvatar="assets/images/icons/empty-avatar.jpeg",this.scrollTop=0,this.dateBuoyValue="",this.showDateBuoy=!1,this.shouldScroll=!1,this.isScrollToBottom=!0}get dateBuoyLeft(){return`calc(60px + ${this.$window.submenuWidth}px + ${this.$window.pageWidth/2}px)`}ngOnInit(){this.$user.user$.pipe(Object(s.a)(1)).subscribe(e=>this.userId=e.id),Object(g.a)([this.$user.friends$.pipe(Object(r.a)(e=>e.length>0)),this.activatedRoute.params.pipe(Object(r.a)(({id:e})=>!!e)).pipe(Object(a.a)(()=>this.shouldScroll=!0)),this.$feature.messageHistory$]).pipe(Object(c.a)(this.onDestroy$),Object(l.a)(([e,{id:t},n])=>({friends:e,id:t,messages:n}))).subscribe(({id:e,friends:t,messages:n})=>this.initial(e,t,n.filter(({userId:t})=>t===e)))}showAvatar(e,t,n){return(0===t||e[t].sendTime.toDate().toISOString().split(":")[1]!==e[t-1].sendTime.toDate().toISOString().split(":")[1])&&n.sendTo===this.userId}showDateDivider(e,t,n){return 0===t||n.sendTime.toDate().toLocaleDateString()!==e[t-1].sendTime.toDate().toLocaleDateString()}isAppendage(e,t,n){return!(this.isDiffMin(e,t,!0)||this.isDiffUser(e,t,n,!0))}afterKeydown(e){var t;"Enter"!==e.key||""===this.message.trim()||e.isComposing||this.$feature.fireEvent({action:d.a.SendMessage,id:this.userId,friendId:null===(t=this.friend)||void 0===t?void 0:t.id,message:this.message}).then(()=>this.message="")}updateMessages(e){var t,n;switch(this.messageHistory=e,null===(t=e[e.length-1])||void 0===t?void 0:t.sendTo){case this.userId:this.markMessageAsRead(e.filter(({sendTo:e})=>e===this.userId).map(({id:e})=>e));break;case null===(n=this.friend)||void 0===n?void 0:n.id:this.shouldScroll=!0}}onScroll({scrollTop:e,scrollHeight:t,clientHeight:n}){var o,i,s;this.isScrollStop=!1;const r=null===(o=this.tDateBuoy)||void 0===o?void 0:o.nativeElement.getBoundingClientRect().y,a=null===(i=this.tDateDividers)||void 0===i?void 0:i.map(e=>e.nativeElement.getBoundingClientRect().y).filter(e=>e<=r);this.dateBuoyValue=(null===(s=this.tDateDividers)||void 0===s?void 0:s.toArray()[0===a.length?0:a.length-1]).nativeElement.innerText,this.isScrollToBottom=e+n>=t}onScrollEnd(){this.isScrollStop=!0}scrollToBottom(e,{clientHeight:t}){e.scrollTop=t}initial(e,t,n){this.friend=t.find(({id:t})=>t===e),this.updateMessages(n),this.observer||setTimeout(()=>this.settingObserver(),0)}markMessageAsRead(e){var t;this.$feature.fireEvent({action:d.a.ReadMessage,id:this.userId,friendId:null===(t=this.friend)||void 0===t?void 0:t.id,messageIds:e})}settingObserver(){var e;this.observer=p.a.generateResizeObserver(e=>{this.shouldScroll&&(this.scrollTop=e.contentRect.height,this.shouldScroll=!1)}),this.observer.observe(null===(e=this.tMessages)||void 0===e?void 0:e.nativeElement)}onDestroy(){var e;null===(e=this.observer)||void 0===e||e.disconnect()}isDiffMin(e,t,n){return(n?0===t:t===e.length-1)||e[t].sendTime.toDate().toISOString().split(":")[1]!==e[n?t-1:t+1].sendTime.toDate().toISOString().split(":")[1]}hideTime(e,t,n){return!this.isDiffMin(e,t,!1)&&!this.isDiffUser(e,t,n,!1)}isDiffUser(e,t,n,o){return(o?0===t:t===e.length-1)||n.sendTo!==e[o?t-1:t+1].sendTo}}return e.\u0275fac=function(t){return new(t||e)(b.Jb(u.a),b.Jb(h.a),b.Jb(m.a),b.Jb(i.a))},e.\u0275cmp=b.Db({type:e,selectors:[["app-chat"]],viewQuery:function(e,t){if(1&e&&(b.tc(v,!0),b.tc(C,!0),b.tc(w,!0)),2&e){let e;b.gc(e=b.Wb())&&(t.tMessages=e.first),b.gc(e=b.Wb())&&(t.tDateBuoy=e.first),b.gc(e=b.Wb())&&(t.tDateDividers=e)}},features:[b.vb],decls:3,vars:2,consts:[[4,"ngIf","ngIfElse"],["empty",""],[1,"w-100"],["tHeader",""],[1,"material-icons"],[4,"ngIf"],["class","scroll-bar","appScrollControl","",3,"scrollTop","height","scrolling","scrollEnd",4,"ngIf"],["tFooter",""],["placeholder","\u8acb\u8f38\u5165\u8a0a\u606f",1,"p-0",3,"ngModel","ngModelChange","keydown"],[1,"d-flex","flex-row","align-itmes-center"],["rotate45","",1,"material-icons"],["appScrollControl","",1,"scroll-bar",3,"scrollTop","scrolling","scrollEnd"],["tScrollContainer",""],["class","date-buoy",3,"left","fade-out","fade-in",4,"ngIf"],["tMessages",""],[4,"ngFor","ngForOf"],[1,"scroll-button",3,"click"],[1,"date-buoy"],["tDateBuoy",""],["class","date-divider",4,"ngIf"],[1,"message"],[1,"avatar"],["alt","",3,"src",4,"ngIf"],[1,"content"],[1,"text"],[1,"caption"],[1,"time"],[1,"date-divider"],["tDateDividers",""],["alt","",3,"src"],[1,"content-empty"]],template:function(e,t){if(1&e&&(b.nc(0,E,24,6,"ng-container",0),b.nc(1,B,5,0,"ng-template",null,1,b.oc)),2&e){const e=b.hc(2);b.dc("ngIf",t.friend)("ngIfElse",e)}},directives:[o.l,O.a,O.i,O.k,y,x,o.k],pipes:[o.b,_,M],styles:["[_nghost-%COMP%]{display:block;height:100%}header[_ngcontent-%COMP%], nav[_ngcontent-%COMP%]{display:flex;flex-direction:row;align-items:center}header[_ngcontent-%COMP%]{justify-content:space-between;height:50px;padding:0 .8rem;position:relative}header[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{margin-right:.5rem;font-size:.875rem}app-chat-announcement[_ngcontent-%COMP%]{width:100%;position:absolute;top:50px;left:0;height:40px}.filter[_ngcontent-%COMP%]{width:100%;background:red}footer[_ngcontent-%COMP%]{position:relative;z-index:2;border-top:1px solid #f5f5f5;padding:.9rem 1rem 0;background:#fff}footer[_ngcontent-%COMP%]   textarea[_ngcontent-%COMP%]{outline:none;display:block;width:100%;min-height:80px;max-height:140px;border:none;resize:none;font-size:.75rem}footer[_ngcontent-%COMP%]   textarea[_ngcontent-%COMP%]::placeholder{color:rgba(0,0,0,.2);font-size:.75rem}footer[_ngcontent-%COMP%]   nav[_ngcontent-%COMP%]{height:50px;padding:0 0 5px;display:flex;flex-direction:row;width:100%;justify-content:space-between}.content-empty[_ngcontent-%COMP%]{-webkit-user-select:none;user-select:none;display:flex;flex-direction:column;justify-content:center;align-items:center;width:100%;height:100%;color:#d0d5db;background:#f2f6f8}.content-empty[_ngcontent-%COMP%]   .material-icons[_ngcontent-%COMP%]{font-size:120px}.content-empty[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{font-size:20px}section[_ngcontent-%COMP%]{position:relative;overflow-y:auto;min-width:300px;padding:12px}section[_ngcontent-%COMP%]   .date-buoy[_ngcontent-%COMP%]{display:inline-block;z-index:2;top:calc(47px + 50px + 50px);transform:translateX(-50%);padding:6px 12px;font-size:.75rem;color:#595c61;border:1px solid #e0e1e3;border-radius:14px}section[_ngcontent-%COMP%]   .date-buoy[_ngcontent-%COMP%], section[_ngcontent-%COMP%]   .scroll-button[_ngcontent-%COMP%]{position:fixed;background-color:#fff;opacity:0}section[_ngcontent-%COMP%]   .scroll-button[_ngcontent-%COMP%]{bottom:155px;right:8px;width:37px;height:37px;border:1px solid #e7e2e2;border-radius:50%;box-shadow:0 0 5px 1px rgba(0,0,0,.05);animation:fade-in .2s ease-in forwards}.date-divider[_ngcontent-%COMP%], section[_ngcontent-%COMP%]   .scroll-button[_ngcontent-%COMP%]{display:flex;align-items:center;justify-content:center}.date-divider[_ngcontent-%COMP%]{margin:21px 0 10px}.date-divider[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{padding:6px 12px;font-size:.75rem;color:#afb1b5;background-color:#f2f6f8;border-radius:11px}.message[_ngcontent-%COMP%]{align-items:center;font-size:.875rem}.message[_ngcontent-%COMP%], .message[_ngcontent-%COMP%]   .content[_ngcontent-%COMP%]{display:flex;flex-direction:row}.message[_ngcontent-%COMP%]   .content[_ngcontent-%COMP%]{position:relative;align-items:flex-end}.message[_ngcontent-%COMP%]   .text[_ngcontent-%COMP%]{margin:4px 0;padding:7px 11px;line-height:17px;word-wrap:break-word;border-radius:16px}.message[_ngcontent-%COMP%]   .caption[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-items:flex-start;min-width:-moz-fit-content;min-width:fit-content;padding:0 7px;font-size:.75rem;color:#afb1b5;white-space:nowrap}.message[_ngcontent-%COMP%]   .time[_ngcontent-%COMP%]{height:14px;padding:3px 0}.message.subMessage[_ngcontent-%COMP%]{padding-top:0}.message__myself[_ngcontent-%COMP%]{justify-content:flex-end;padding:13px 0 5px}.message__myself[_ngcontent-%COMP%]   .content[_ngcontent-%COMP%]{flex-direction:row-reverse;padding-right:12px}.message__myself[_ngcontent-%COMP%]   .content[_ngcontent-%COMP%]   span[_ngcontent-%COMP%]{position:absolute;right:2px;top:-15px;width:23px;height:23px;border-radius:50%;box-shadow:8px 2px #a3cdfd;transform:rotate(73deg)}.message__myself[_ngcontent-%COMP%]   .caption[_ngcontent-%COMP%]{align-items:flex-end}.message__myself[_ngcontent-%COMP%]   .text[_ngcontent-%COMP%]{position:relative;background:#a3cdfd}.message__friend[_ngcontent-%COMP%]{justify-content:flex-start;align-items:flex-end;padding:23px 0 6px}.message__friend[_ngcontent-%COMP%]   .content[_ngcontent-%COMP%]{padding-left:12px}.message__friend[_ngcontent-%COMP%]   .content[_ngcontent-%COMP%]   span[_ngcontent-%COMP%]{position:absolute;left:-1px;top:-11px;width:23px;height:20px;border-radius:50%;box-shadow:8px 2px #e9ebec;transform:rotate(67deg)}.message__friend[_ngcontent-%COMP%]   .text[_ngcontent-%COMP%]{display:flex;background:#e9ebec}.message__friend[_ngcontent-%COMP%]   .avatar[_ngcontent-%COMP%]{min-width:41px;margin-right:2px}.message__friend[_ngcontent-%COMP%]   .avatar[_ngcontent-%COMP%]   img[_ngcontent-%COMP%]{width:41px;height:41px;border-radius:50%;object-fit:cover}.small-padding[_ngcontent-%COMP%]{padding:0 0 5px}.fade-down-out[_ngcontent-%COMP%]{animation:fade-down-out 1.5s ease-out forwards!important}.fade-out[_ngcontent-%COMP%]{animation:fade-out 1s ease-in forwards}.fade-in[_ngcontent-%COMP%]{animation:fade-in .2s ease-in forwards}@keyframes fade-in{0%{opacity:0;color:#fff}to{opacity:.9;color:#0e0e0e}}@keyframes fade-out{0%{opacity:.8;color:#0e0e0e}to{opacity:0;color:#fff}}@keyframes fade-down-out{0%{opacity:.9;transform:translateY(0)}to{opacity:.9;transform:translateY(75px)}}"]}),e})();const H=[{path:"",component:Y},{path:":id",component:Y}];let j=(()=>{class e{}return e.\u0275mod=b.Hb({type:e}),e.\u0275inj=b.Gb({factory:function(t){return new(t||e)},imports:[[i.e.forChild(H)],i.e]}),e})();var z=n("FpXt");let L=(()=>{class e{}return e.\u0275mod=b.Hb({type:e}),e.\u0275inj=b.Gb({factory:function(t){return new(t||e)},imports:[[z.a,o.c,j]]}),e})()}}]);